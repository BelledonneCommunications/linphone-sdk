variables:
  GIT_SUBMODULE_STRATEGY: recursive


job-android:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r17b
  tags: [ "docker" ]

  cache:
    paths:
      - ccache/

  before_script:
    - mkdir -p ccache
    - export CCACHE_BASEDIR=${PWD}
    - export CCACHE_DIR=${PWD}/ccache

  script:
    - sdkmanager
    - mkdir build-android
    - cd build-android
    - cmake .. -DLINPHONESDK_PLATFORM=Android -DLINPHONESDK_ANDROID_ARCHS="arm64, armv7, x86, x86_64"
    - cmake --build . --target sdk >> build_log.txt 2>&1

  artifacts:
    paths:
      - build-android/build_log.txt
      - build-android/linphone-sdk/bin/outputs/aar/*.aar
      - build-android/linphone-sdk/bin/distributions/linphone-sdk-*.zip
    when: always
    expire_in: 1 week


job-ios:

  tags: [ "macosx" ]

  cache:
    paths:
      - ccache/

  before_script:
    - mkdir -p ccache
    - export CCACHE_BASEDIR=${PWD}
    - export CCACHE_DIR=${PWD}/ccache

  script:
    - mkdir build-ios
    - cd build-ios
    - cmake .. -DLINPHONESDK_PLATFORM=IOS -DLINPHONESDK_IOS_ARCHS="arm64, armv7, i386, x86_64"
    - cmake --build . --target sdk >> build_log.txt 2>&1

  artifacts:
    paths:
      - build-ios/build_log.txt
      - build-ios/linphone-sdk-*.zip
      - build-ios/linphone-sdk.podspec
    when: always
    expire_in: 1 week


.job-desktop-template: &job-desktop-definition

  cache:
    paths:
      - ccache/

  before_script:
    - mkdir -p ccache
    - export CCACHE_BASEDIR=${PWD}
    - export CCACHE_DIR=${PWD}/ccache

  script:
    - mkdir build-desktop
    - cd build-desktop
    - cmake .. -DLINPHONESDK_PLATFORM=Desktop
    - cmake --build . --target sdk >> build_log.txt 2>&1

  artifacts:
    paths:
      - build-desktop/build_log.txt
    when: always
    expire_in: 1 week


job-centos7:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-centos:7
  tags: [ "docker" ]
  <<: *job-desktop-definition


job-debian8:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:8
  tags: [ "docker" ]
  <<: *job-desktop-definition


job-debian9:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:9
  tags: [ "docker" ]
  <<: *job-desktop-definition


job-macosx:

  tags: [ "macosx" ]
  <<: *job-desktop-definition
