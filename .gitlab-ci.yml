variables:
  GIT_SUBMODULE_STRATEGY: recursive


.linux-ccache-template: &linux-ccache-definition
  cache:
    key: $CI_JOB_NAME
    paths:
      - ccache/

  before_script:
    - mkdir -p ccache
    - export CCACHE_BASEDIR=${PWD}
    - export CCACHE_DIR=${PWD}/ccache


.job-android-template: &job-android-definition

  tags: [ "docker" ]

  <<: *linux-ccache-definition

  script:
    - ccache -s
    - sdkmanager
    - mkdir -p build-android
    - cd build-android
    - cmake .. -G "$CMAKE_GENERATOR" -DLINPHONESDK_PLATFORM=Android -DLINPHONESDK_ANDROID_ARCHS="arm64, armv7, x86, x86_64"
    - cmake --build . --target sdk -- $ADDITIONAL_BUILD_OPTIONS >> build_log.txt 2>&1
    - ccache -s

  artifacts:
    paths:
      - build-android/build_log.txt
      - build-android/linphone-sdk/bin/outputs/aar/*.aar
      - build-android/linphone-sdk/bin/distributions/linphone-sdk-*.zip
    when: always
    expire_in: 1 week


#job-android-makefile-r16b:
#
#  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r16b
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    ADDITIONAL_BUILD_OPTIONS: -j2
#
#  <<: *job-android-definition


job-android-ninja-r16b:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r16b
  variables:
    CMAKE_GENERATOR: Ninja

  <<: *job-android-definition


#job-android-makefile-r17c:
#
#  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r17c
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    ADDITIONAL_BUILD_OPTIONS: -j2
#
#  <<: *job-android-definition


job-android-ninja-r17c:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r17c
  variables:
    CMAKE_GENERATOR: Ninja

  <<: *job-android-definition


.job-ios-template: &job-ios-definition

  tags: [ "macosx" ]

  script:
    - ccache -s
    - mkdir -p build-ios
    - cd build-ios
    - cmake .. -G "$CMAKE_GENERATOR" -DLINPHONESDK_PLATFORM=IOS -DLINPHONESDK_IOS_ARCHS="arm64, armv7, i386, x86_64"
    - cmake --build . --target sdk -- $ADDITIONAL_BUILD_OPTIONS >> build_log.txt 2>&1
    - ccache -s

  artifacts:
    paths:
      - build-ios/build_log.txt
      - build-ios/linphone-sdk-*.zip
      - build-ios/linphone-sdk.podspec
    when: always
    expire_in: 1 week


#job-ios-makefile:
#
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    ADDITIONAL_BUILD_OPTIONS: -j2
#
#  <<: *job-ios-definition


job-ios-ninja:

  variables:
    CMAKE_GENERATOR: Ninja

  <<: *job-ios-definition


#job-ios-xcode:
#
#  variables:
#    CMAKE_GENERATOR: Xcode
#
#  <<: *job-ios-definition


.job-linux-desktop-template: &job-linux-desktop-definition

  tags: [ "docker" ]

  <<: *linux-ccache-definition

  script:
    - export CC=$CC
    - export CXX=$CXX
    - ccache -s
    - mkdir -p build-desktop
    - cd build-desktop
    - cmake .. -G "$CMAKE_GENERATOR" -DLINPHONESDK_PLATFORM=Desktop
    - cmake --build . --target sdk -- $ADDITIONAL_BUILD_OPTIONS >> build_log.txt 2>&1
    - ccache -s

  artifacts:
    paths:
      - build-desktop/build_log.txt
    when: always
    expire_in: 1 week


#job-centos7-makefile-gcc:
#
#  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-centos:7
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    CC: gcc
#    CXX: g++
#  <<: *job-linux-desktop-definition


#job-debian8-makefile-gcc:
#
#  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:8
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    CC: gcc
#    CXX: g++
#    ADDITIONAL_BUILD_OPTIONS: -j2
#  <<: *job-linux-desktop-definition


#job-debian9-makefile-gcc:
#
#  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:9
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    CC: gcc
#    CXX: g++
#    ADDITIONAL_BUILD_OPTIONS: -j2
#  <<: *job-linux-desktop-definition


job-centos7-ninja-gcc:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-centos:7
  variables:
    CMAKE_GENERATOR: Ninja
    CC: gcc
    CXX: g++
  <<: *job-linux-desktop-definition


job-debian8-ninja-gcc:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:8
  variables:
    CMAKE_GENERATOR: Ninja
    CC: gcc
    CXX: g++
  <<: *job-linux-desktop-definition


job-debian9-ninja-gcc:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:9
  variables:
    CMAKE_GENERATOR: Ninja
    CC: gcc
    CXX: g++
  <<: *job-linux-desktop-definition


#job-centos7-makefile-clang:
#
#  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-centos:7
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    CC: clang
#    CXX: clang++
#  <<: *job-linux-desktop-definition


#job-debian8-makefile-clang:
#
#  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:8
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    CC: clang
#    CXX: clang++
#    ADDITIONAL_BUILD_OPTIONS: -j2
#  <<: *job-linux-desktop-definition


#job-debian9-makefile-clang:
#
#  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:9
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    CC: clang
#    CXX: clang++
#    ADDITIONAL_BUILD_OPTIONS: -j2
#  <<: *job-linux-desktop-definition


job-centos7-ninja-clang:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-centos:7
  variables:
    CMAKE_GENERATOR: Ninja
    CC: clang
    CXX: clang++
  <<: *job-linux-desktop-definition


job-debian8-ninja-clang:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:8
  variables:
    CMAKE_GENERATOR: Ninja
    CC: clang
    CXX: clang++
  <<: *job-linux-desktop-definition


job-debian9-ninja-clang:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:9
  variables:
    CMAKE_GENERATOR: Ninja
    CC: clang
    CXX: clang++
  <<: *job-linux-desktop-definition


.job-macosx-desktop-template: &job-macosx-desktop-definition

  tags: [ "macosx" ]

  script:
    - ccache -s
    - mkdir -p build-desktop
    - cd build-desktop
    - cmake .. -G "$CMAKE_GENERATOR" -DLINPHONESDK_PLATFORM=Desktop
    - cmake --build . --target sdk -- $ADDITIONAL_BUILD_OPTIONS >> build_log.txt 2>&1
    - ccache -s

  artifacts:
    paths:
      - build-desktop/build_log.txt
    when: always
    expire_in: 1 week


#job-macosx-makefile:
#
#  variables:
#    CMAKE_GENERATOR: Unix Makefiles
#    ADDITIONAL_BUILD_OPTIONS: -j2
#  <<: *job-macosx-desktop-definition


job-macosx-ninja:

  variables:
    CMAKE_GENERATOR: Ninja
  <<: *job-macosx-desktop-definition


job-macosx-xcode:

  variables:
    CMAKE_GENERATOR: Xcode
  <<: *job-macosx-desktop-definition


job-windows-vs2015:

  tags: [ "windows" ]

  script:
    - mkdir build-desktop
    - cd build-desktop
    - cmake .. -G "Visual Studio 14 2015" -DLINPHONESDK_PLATFORM=Desktop -DCMAKE_BUILD_TYPE=Release
    - cmake --build . --target sdk --config Release -- /maxcpucount
