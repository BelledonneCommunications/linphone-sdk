xamarin-package:
  stage: package
<<<<<<< HEAD
  tags: [ "macmini-m1-xcode12" ]
  variables:
    GIT_STRATEGY: fetch
  needs:
    - ios-xcode
    - android-makefile-r20-g729

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
       - .gitlab-ci-files/xamarin/packages.yml
       - cmake/NuGet/Xamarin/**/*
    - if: $DEPLOY_RUN_NUGET
    - if: $UPLOAD_XAMARIN
    - if: $NIGHTLY_RELEASE
    - if: $NIGHTLY_MASTER


  before_script:
    #removing previous results directory to avoid getting incorrect artifacts for current launch
    - if [ -d "$CI_PROJECT_DIR/results" ]; then rm -rf $CI_PROJECT_DIR/results; fi;
    - if [ -d "$CI_PROJECT_DIR/linphone-sdk-xamarin" ]; then rm -rf $CI_PROJECT_DIR/linphone-sdk-xamarin; fi; # unzipped iOS artifacts
    - if [ -d "$CI_PROJECT_DIR/build-nuget" ]; then rm -rf $CI_PROJECT_DIR/build-nuget; fi; # cmake build dir


  script:
   - unzip $CI_PROJECT_DIR/build-ios/linphone-sdk-ios-* -d linphone-sdk-xamarin
   - mkdir -p build-nuget
   - cd build-nuget
   # The C# wrapper is used both by Android and iOS but it's arbitrarily compiled in the iOS build (it has to come from somewhere)
   - cmake ..
     -DLINPHONESDK_PACKAGER="Nuget"
     -DLINPHONESDK_CSHARP_WRAPPER_PATH="$CI_PROJECT_DIR/linphone-sdk-xamarin/linphone-sdk/apple-darwin/share/linphonecs/LinphoneWrapper.cs"
     -DLINPHONESDK_IOS_FRAMEWORKS_PATH="$CI_PROJECT_DIR/linphone-sdk-xamarin/linphone-sdk/apple-darwin/Frameworks"
     -DLINPHONESDK_ANDROID_AAR_PATH="$CI_PROJECT_DIR/build/linphone-sdk/bin/outputs/aar/linphone-sdk-android-release.aar"
     -DCMAKE_INSTALL_PREFIX="$CI_PROJECT_DIR/results"
   - cmake --build .


=======
  tags: [ "deploy" ]
  variables:
    GIT_STRATEGY: none
  needs:
    - ios-ninja
    - android-makefile-r20

  rules:
    - if: $UPLOAD_XAMARIN
    - if: $NIGHTLY_RELEASE
  script:
    #removing previous results directory to avoid getting incorrect artifacts for current launch
    - if [ -d "$CI_PROJECT_DIR/results" ]; then rm -rf $CI_PROJECT_DIR/results; fi;
    - if [ -f "$CI_PROJECT_DIR/linphone-sdk-xamarin*" ]; then rm -rf $CI_PROJECT_DIR/linphone-sdk-xamarin*; fi;
    # We are forced to differenciate version of Android and iOS because the commit hash of the git describe has one more char when executed on mac
    - VERSION_ANDROID_DESCRIBE=$(cat ${CI_PROJECT_DIR}/build/gitdescribe.txt)
    - echo $VERSION_ANDROID_DESCRIBE
    - echo $VERSION_ANDROID_DESCRIBE
    - VERSION_ANDROID=$(cat ${CI_PROJECT_DIR}/build/linphonesdkversionandroid.txt)
    - echo $VERSION_ANDROID
    - VERSION_IOS=$(cat ${CI_PROJECT_DIR}/build-ios/linphonesdkversion.txt)
    - echo $VERSION_IOS
    - cd build/linphone-sdk/bin/distributions/
    - ls .
    #- VERSION=$(ls linphone-sdk-android* | sed -e 's/linphone-sdk-android-//g')
    - unzip linphone-sdk-android-$VERSION_ANDROID -d linphone-sdk-android
    - unzip $CI_PROJECT_DIR/build-ios/linphone-sdk-ios-$VERSION_IOS -d linphone-sdk-ios
    - zip -r $CI_PROJECT_DIR/linphone-sdk-xamarin-$VERSION.zip linphone-sdk-android linphone-sdk-ios
    - ls $CI_PROJECT_DIR/linphone-sdk-xamarin*

  after_script:
    - mkdir -p $CI_PROJECT_DIR/results/xamarin
    - cp $CI_PROJECT_DIR/linphone-sdk-xamarin*.zip $CI_PROJECT_DIR/results/xamarin
    #Cleaning also previous artifacts to avoid conflicts with future jobs
    - rm -r $CI_PROJECT_DIR/build/linphone-sdk/bin/distributions/*
    - rm -r $CI_PROJECT_DIR/build-ios/linphone-sdk-ios*
    - rm $CI_PROJECT_DIR/linphone-sdk-xamarin*
>>>>>>> origin/release/5.1
  artifacts:
    paths:
      - results/*
    when: always
    expire_in: 1 week
