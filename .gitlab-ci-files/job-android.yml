.job-android:

  stage: build
  tags: [ "docker-android" ]

  variables:
    CCACHE_SIZE: 4G

  extends: .linux-prepare

  script:
    - sdkmanager
    - mkdir -p build-android
    - cd build-android
    - cmake .. -G "$CMAKE_GENERATOR" -DLINPHONESDK_PLATFORM=Android -DLINPHONESDK_ANDROID_ARCHS="$ANDROID_ARCHS" $DEFAULT_LINUX_CMAKE_OPTIONS $CMAKE_OPTIONS
    - cmake --build . --target sdk -- $ADDITIONAL_BUILD_OPTIONS

  artifacts:
    paths:
      - build-android/linphone-sdk/bin/outputs/aar/*.aar
      - build-android/linphone-sdk/bin/distributions/linphone-sdk-*.zip
    when: always
    expire_in: 1 week


#################################################
# Makefile
#################################################


job-android-makefile-r16b:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r16b
  only:
    variables:
      - $NIGHTLY_MASTER
  variables:
    CMAKE_GENERATOR: Unix Makefiles
    ADDITIONAL_BUILD_OPTIONS: -j$MAKEFILE_JOBS
  extends: .job-android


job-android-makefile-r17c:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r17c
  only:
    variables:
      - $NIGHTLY_MASTER
  variables:
    CMAKE_GENERATOR: Unix Makefiles
    ADDITIONAL_BUILD_OPTIONS: -j$MAKEFILE_JOBS
  extends: .job-android


job-android-makefile-r18b:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r18b
  only:
    variables:
      - $NIGHTLY_MASTER
  variables:
    CMAKE_GENERATOR: Unix Makefiles
    CMAKE_OPTIONS: -DENABLE_UNIT_TESTS=ON
    ADDITIONAL_BUILD_OPTIONS: -j$MAKEFILE_JOBS
  extends: .job-android


job-android-makefile-r19:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r19
  only:
    variables:
      - $NIGHTLY_MASTER
  variables:
    CMAKE_GENERATOR: Unix Makefiles
    ADDITIONAL_BUILD_OPTIONS: -j$MAKEFILE_JOBS
  extends: .job-android


#################################################
# Ninja
#################################################


job-android-ninja-r16b:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r16b
  only:
    variables:
      - $NIGHTLY_MASTER
  variables:
    CMAKE_GENERATOR: Ninja
  extends: .job-android


job-android-ninja-r16b-novideo:
  only:
    variables:
      - $NIGHTLY_MASTER
  variables:
    CMAKE_OPTIONS: -DENABLE_VIDEO=NO
  extends: job-android-ninja-r16b


job-android-ninja-r17c:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r17c
  variables:
    CMAKE_GENERATOR: Ninja
  extends: .job-android


job-android-ninja-r17c-novideo:
  only:
    variables:
      - $NIGHTLY_MASTER
  variables:
    CMAKE_OPTIONS: -DENABLE_VIDEO=NO
  extends: job-android-ninja-r17c


job-android-ninja-r18b:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r18b
  only:
    variables:
      - $NIGHTLY_MASTER
  variables:
    CMAKE_GENERATOR: Ninja
  extends: .job-android


job-android-ninja-r19:

  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r19
  only:
    variables:
      - $NIGHTLY_MASTER
  variables:
    CMAKE_GENERATOR: Ninja
  extends: .job-android
  
  
test-android-r17c:
  tags: [ "docker-android-test-r17c" ]
  stage: test
  allow_failure: true
  only:
    refs:
      - feature/android_tester_ci
  script:
    - cd ${CI_PROJECT_DIR}/tester/Android
    # uninstalling tester app on device to prevent conflicts
    - adb uninstall org.linphone.tester.test
    - adb uninstall org.linphone.tester
    
    # build of the testers
    - ./gradlew assembleDebug
    - ./gradlew assembleDebugAndroidTest
    
    #Test launching (currently only Message)
    - java -jar ./spoon.jar \
      --output spoon \
      --apk app/build/outputs/apk/debug/app-debug.apk \
      --test-apk app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
      --class-name 'org.linphone.tester.MessageTests' \
      --fail-on-failure --fail-if-no-device-connected --grant-all || ( if [ $? -ne 0 ]
      then
        echo "Some tests are failed"
        for x in `adb devices | sed -n '1!p' | sed '/^$/d' | awk '{print $1;}'`; do
          cat $x.txt | ndk-stack -sym ../../build/libs-debug/`adb -s $x shell getprop ro.product.cpu.abi | tr -d '\r'` > $x-ndk-#stack.txt
        done
      fi)
    - tar zcvf logs-tests-android.tar.gz spoon/ *.txt
    
  after_script:
    - sudo mkdir ${CI_PROJECT_DIR}/results
    - sudo chmod 777 ${CI_PROJECT_DIR}/results
    - mv logs-tests-android.tar.gz ${CI_PROJECT_DIR}/results
    
  artifacts:
    paths:
      - results/*
      
    when: always
    expire_in: 4 week
