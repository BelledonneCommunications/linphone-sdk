stages:
  -docker-build-rebuild
  -docker-test-rebuild
  -build
  -test


job-docker-build-image-rebuild:
  stage: docker-build-rebuild
  tags: [ "shuttle-linux" ]
  only:
    variables:
      - $DOCKER_UPDATE
  script:
    - docker pull ubuntu:rolling
    - cd docker-files
    - docker build -f ./bc-dev-ubuntu-rolling -t gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu:rollingupdated --rm --no-cache .
    - docker login gitlab.linphone.org:4567
    - docker push gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu:rollingupdated

job-docker-test-ms-image-rebuild:
  stage: docker-test-rebuild
  tags: [ "shuttle-linux" ]
  only:
    variables:
      - $DOCKER_UPDATE
  dependencies:
    - job-ubuntu-rolling-testbuild-makefile-gcc
  script:
    - docker pull gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu:rollingupdated
    - cd docker-files
    - docker build -f ./bc-dev-ubuntu-rolling-test-mediastreamer -t gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu-test-mediastreamer:latestupdated --rm --no-cache .
    - docker login gitlab.linphone.org:4567
    - docker push gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu-test-mediastreamer:latestupdated

job-docker-test-liblinphone-image-rebuild:
  stage: docker-test-rebuild
  tags: [ "shuttle-linux" ]
  only:
    variables:
      - $DOCKER_UPDATE
  dependencies:
    - job-docker-test-ms-image-rebuild
  script:
    - docker pull gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu-rolling-test-mediastreamer:lastestupdated
    - cd docker-files
    - docker build -f ./bc-dev-ubuntu-rolling-test-liblinphone -t gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu-test-liblinphone:latestupdated --rm --no-cache .
    - docker login gitlab.linphone.org:4567
    - docker push gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu-test-liblinphone:latestupdated

job-ubuntu-rolling-testbuild-makefile-gcc:
  extends: job-ubuntu-rolling-makefile-gcc
  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu:rollingupdated
  only:
    variables:
      - $DOCKER_UPDATE
  dependencies:
    - job-docker-build-image-rebuild
test-ubuntu-rolling-testbuild-makefile-gcc:
  extends: test-liblinphone-ubuntu
  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-ubuntu-rolling-test-liblinphone:latestupdated
  only:
    variables:
      - $DOCKER_UPDATE
  dependencies:
    - job-ubuntu-rolling-testbuild-makefile-gcc
