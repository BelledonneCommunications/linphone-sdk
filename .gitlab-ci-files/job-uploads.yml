#################################################
# iOS
#################################################


job-ios-upload:

  stage: deploy
  tags: [ "deploy" ]

  only:
    variables:
      - $DEPLOY_RUN_IOS
      - $NIGHTLY_MASTER

  dependencies:
    - job-ios-ninja

  script:
    - scp build-ios/linphone-sdk-*.zip $DEPLOY_SERVER:$DEPLOY_SNAPSHOTS_ROOT_DIRECTORY/ios/
    - pod repo remove linphone-sdk || true
    - pod repo add linphone-sdk git@gitlab.linphone.org:BC/public/podspec.git $CI_COMMIT_REF_NAME
    - pod repo push linphone-sdk build-ios/linphone-sdk.podspec --skip-import-validation --local-only --verbose
    - cd ~/.cocoapods/repos/linphone-sdk && git push origin $CI_COMMIT_REF_NAME && cd -
    - pod repo remove linphone-sdk


#################################################
# Android
#################################################

job-android-upload:

  stage: deploy
  tags: [ "docker-android" ]
  image: gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-android:r17c

  only:
    variables:
      - $DEPLOY_RUN_ANDROID
      - $NIGHTLY_MASTER

  variables:
    CCACHE_SIZE: 4G
    CMAKE_GENERATOR: Ninja
    ADDITIONAL_BUILD_OPTIONS: -j$MAKEFILE_JOBS
    GIT_STRATEGY: clone
    GRADLE_OPTIONS: -i

  dependencies:
    - job-android-ninja-r17c

  before_script:
    - eval $(ssh-agent -s)
    - echo "$DEPLOY_USER_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo -e "Host gitlab.linphone.org\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - echo -e "Host linphone.org\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    
# Currently we can't use artifact to upload this so we rebuild all android project

  script:
    - git config --global user.email "gitlab@belledonne-communications.com"
    - git config --global user.name "Gitlab"
    - mkdir -p build-android
    - cd build-android
    - cmake .. -G "$CMAKE_GENERATOR" -DLINPHONESDK_PLATFORM=Android -DLINPHONESDK_ANDROID_ARCHS="arm64, armv7, x86_64, x86" $DEFAULT_LINUX_CMAKE_OPTIONS $CMAKE_OPTIONS
    - cmake --build . --target sdk -- $ADDITIONAL_BUILD_OPTIONS
    - rsync -ave ssh --exclude "*.aar" --exclude "*.jar" $ANDROID_MAVEN_URL maven_repository
    - ../cmake/Android/gradlew publish $GRADLE_OPTIONS
    - rsync -ave ssh ./maven_repository/* $ANDROID_MAVEN_URL

  after_script:
    - rm -rf ~/.ssh || true

job-android-upload-no-video:

  extends: job-android-upload

  variables:
    CMAKE_OPTIONS: -DENABLE_VIDEO=NO
    GRADLE_OPTIONS: -Pno-video -i


job-android-upload-legacy:

  extends: job-android-upload
  
  variables:
    CMAKE_OPTIONS: -DENABLE_JAVA_WRAPPER=NO
    GRADLE_OPTIONS: -Plegacy-wrapper -i
    
#################################################
# Macosx
#################################################


job-macosx-upload:

  stage: deploy
  tags: [ "deploy" ]

  only:
    variables:
      - $DEPLOY_RUN_MACOSX
      - $NIGHTLY_MASTER

  dependencies:
    - job-macosx-xcode

  script:
    - scp build-desktop/linphone-sdk-*.zip $DEPLOY_SERVER:$DEPLOY_SNAPSHOTS_ROOT_DIRECTORY/macosx/
    - pod repo remove linphone-sdk-macosx || true
    - pod repo add linphone-sdk-macosx git@gitlab.linphone.org:BC/public/podspec-macos.git $CI_COMMIT_REF_NAME
    - pod repo push linphone-sdk-macosx build-desktop/linphone-sdk.podspec --skip-import-validation --local-only --verbose
    - cd ~/.cocoapods/repos/linphone-sdk-macosx && git push origin $CI_COMMIT_REF_NAME && cd -
    - pod repo remove linphone-sdk-macosx
    
job-debian-doc-upload:
  stage: deploy
  tags: [ "deploy" ]

  only:
    variables:
      - $NIGHTLY_MASTER
    
  dependencies:
    - job-debian9-ninja-clang

  script:
    - cd linphone
    #getting the version number to push the right version of the doc
    - LINPHONE_VERSION=$(git describe | sed -e 's/-.*//g')
    - echo "Linphone verison =" $LINPHONE_VERSION
    - rsync -rlv ../build-desktop/linphone-sdk/desktop/share/doc/linphone/$LINPHONE_VERSION/* $DEPLOY_SERVER:$DEPLOY_SNAPSHOTS_ROOT_DIRECTORY/docs/liblinphone/multilang
