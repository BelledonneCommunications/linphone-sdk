.job-windows-vs2017:
  extends: .job-prepare
  stage: build
  tags: [ "windows-powershell" ]
  except:
    variables:
      - $DOCKER_UPDATE
      - $SKIP_WINDOWS
  variables:
    CMAKE_OPTIONS: -DENABLE_UNIT_TESTS=ON -DENABLE_LDAP=ON
    LINPHONESDK_PLATFORM: Desktop
    OUTPUT_ZIP_FOLDER: win32
    MINGW_TYPE: mingw32
    CMAKE_GENERATOR: "Visual Studio 15 2017"
  script:

    - Set-Variable -Name "PATH_TEMP" -Value ($(Get-ChildItem -Path Env:\PATH).value)
    - echo $env:Path
    #Remove MinGW of MSYS from PATH and add MINGW_TYPE for MSYS2
    # We double the "\" to escape paths as -replace uses regular expressions
    - $PATH_TEMP = $PATH_TEMP -replace "C:\\MinGW\\bin;" -replace "C:\\Strawberry\\c\\bin;" -replace "C:\\Program Files\\NASM"
    - echo $PATH_TEMP
    - $env:Path = ($PATH_TEMP + ";C:\msys64;C:\msys64\usr\bin;C:\msys64\" + $MINGW_TYPE + "\bin")
    # - set PATH_TEMP=%PATH:C:\MinGW\bin;=%
    # - set PATH_TEMP=%PATH_TEMP:C:\Program Files\NASM=%
    # - set PATH_TEMP=%PATH_TEMP:C:\Strawberry\c\bin;=%
    # - set PATH=%PATH_TEMP%;C:\msys64;C:\msys64\usr\bin;C:\msys64\%MINGW_TYPE%\bin
    #handling the case of previous job cancellation
    - If ($MINGW_TYPE -eq "mingw64") {Import-BatchEnvironment "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"} Else {Import-BatchEnvironment "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\VsDevCmd.bat"}

    - echo $env:Path
    # - IF "%MINGW_TYPE%"=="mingw64" (call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat") ELSE (call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\VsDevCmd.bat")
    - If ( Test-Path -Path "build-desktop" ) {Remove-Item -recurse -force -path "build-desktop" }
    # - IF EXIST build-desktop RMDIR /S /Q build-desktop
    - mkdir build-desktop
    - cd build-desktop
    #we launch the msvc-cl wrapper located in python scripts folder
    #this wrapper relays only needed calls to the real compiler
    #cache stats display
    - C:\PROGRA~1\Python37\Scripts\cl -s
    - Write-Output $DEFAULT_CMAKE_OPTIONS
    - Write-Output $CMAKE_OPTIONS
    - Write-Output $CMAKE_ARCHITECTURE
    - Write-Output $SCHEDULE_CMAKE_OPTIONS
    #We are forced to use Invoke-Expression to explain to powershell that we don't want it to touch to spaces in arguments
    #If we don't use it, '-A Win32' will be interpreted as "-A ' Win32'", thus making the build fail
    - Invoke-Expression "& cmake .. -G '$CMAKE_GENERATOR' -DLINPHONESDK_PLATFORM=$LINPHONESDK_PLATFORM -DENABLE_CSHARP_WRAPPER=YES -DCMAKE_BUILD_TYPE=RelWithDebInfo $DEFAULT_CMAKE_OPTIONS $CMAKE_OPTIONS $CMAKE_ARCHITECTURE $SCHEDULE_CMAKE_OPTIONS"
    # - cmake .. -G  "$CMAKE_GENERATOR" -DLINPHONESDK_PLATFORM="$LINPHONESDK_PLATFORM" -DENABLE_CSHARP_WRAPPER=YES -DCMAKE_BUILD_TYPE=RelWithDebInfo "$DEFAULT_CMAKE_OPTIONS" "$CMAKE_OPTIONS" $CMAKE_ARCHITECTURE "$SCHEDULE_CMAKE_OPTIONS"
    # - Get-Content CMakeCache.txt
    - cmake --build . --target ALL_BUILD --config RelWithDebInfo -- /maxcpucount /nodeReuse:true /p:TrackFileAccess=false
    - C:\PROGRA~1\Python37\Scripts\cl -s
    - cd linphone-sdk
    - mkdir $OUTPUT_ZIP_FOLDER
    - Copy-Item -Path "*.zip" -Destination "$CI_PROJECT_DIR/build-desktop/linphone-sdk/$OUTPUT_ZIP_FOLDER" -Recurse
    # - copy /B *.zip "%CI_PROJECT_DIR%/build-desktop/linphone-sdk/%OUTPUT_ZIP_FOLDER%"
################
  artifacts:
    paths:
      - build-desktop\linphone-sdk\*
    when: always
    expire_in: 1 week

.job-windows-vs2017-ninja:
  extends: .job-prepare
  stage: build
  tags: [ "windows-powershell" ]
  except:
    variables:
      - $DOCKER_UPDATE
      - $SKIP_WINDOWS
      - $DEPLOY_RUN_WINDOWS
  variables:
    CMAKE_OPTIONS: -DENABLE_UNIT_TESTS=ON -DENABLE_LDAP=ON
    MINGW_TYPE: mingw32
  script:
  #Remove MinGW of MSYS from PATH and add MINGW_TYPE for MSYS2

    - Set-Variable -Name "PATH_TEMP" -Value ($(Get-ChildItem -Path Env:\PATH).value)
    # - Set-Variable -Name "PATH_TEMP" -Value ($(Get-ChildItem -Path Env:\PATH).value + ";C:\MinGW\bin;" + "C:\Strawberry\c\bin;" + "C:\Program Files\NASM")

    # We double the "\" to escape paths as -replace uses regular expressions
    - $PATH_TEMP = $PATH_TEMP -replace "C:\\MinGW\\bin;" -replace "C:\\Strawberry\\c\\bin;" -replace "C:\\Program Files\\NASM"
    # -
    # - set PATH_TEMP=%PATH:C:\MinGW\bin;=%
    # - set PATH_TEMP=%PATH_TEMP:C:\Strawberry\c\bin;=%
    # - set PATH_TEMP=%PATH_TEMP:C:\Program Files\NASM=%
    - $env:Path = ($PATH_TEMP + ";C:\msys64;C:\msys64\usr\bin;C:\msys64\" + $MINGW_TYPE + "\bin")

    - echo $env:Path
    # - set PATH=%PATH_TEMP%;C:\msys64;C:\msys64\usr\bin;C:\msys64\%MINGW_TYPE%\bin
    #handling the case of previous job cancellation
    - If ($MINGW_TYPE -eq "mingw64") {Import-BatchEnvironment "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"} Else {Import-BatchEnvironment "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\VsDevCmd.bat"}

    - echo $env:Path
    # - IF "%MINGW_TYPE%"=="mingw64" (call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat") else (call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\VsDevCmd.bat")
    - If ( Test-Path -Path "build-desktop" ) {Remove-Item -recurse -force -path "build-desktop" }
    # - IF EXIST build-desktop RMDIR /S /Q build-desktop
    - mkdir build-desktop
    - cd build-desktop
    #we launch the msvc-cl wrapper located in python scripts folder
    #this wrapper relays only needed calls to the real compiler
    #cache stats display
    # - C:\PROGRA~1\Python37\Scripts\cl -s
    - Write-Output $DEFAULT_CMAKE_OPTIONS
    - Write-Output $CMAKE_OPTIONS
    - Write-Output $CMAKE_ARCHITECTURE
    - Write-Output $SCHEDULE_CMAKE_OPTIONS
    - Write-Output $MAKEFILE_JOBS
    - Write-Output $CMAKE_C_COMPILER
    - Write-Output $CMAKE_CXX_COMPILER
    - Write-Output $CMAKE_RC_COMPILER
    - Write-Output $DEFAULT_CMAKE_OPTIONS
    - Write-Output $CMAKE_OPTIONS
    - Write-Output $CMAKE_ARCHITECTURE
    - Write-Output $SCHEDULE_CMAKE_OPTIONS

    - cmake .. -G "Ninja" -DLINPHONESDK_PLATFORM=Desktop -DENABLE_CSHARP_WRAPPER=YES -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_BUILD_PARALLEL_LEVEL=$MAKEFILE_JOBS -DCMAKE_C_COMPILER="$CMAKE_C_COMPILER" -DCMAKE_CXX_COMPILER="$CMAKE_CXX_COMPILER" -DCMAKE_RC_COMPILER="$CMAKE_RC_COMPILER" $DEFAULT_CMAKE_OPTIONS $CMAKE_OPTIONS $CMAKE_ARCHITECTURE $SCHEDULE_CMAKE_OPTIONS
    - Write-Output -NoEnumerate "Building with Ninja. See ninja_buildlog.txt to get details before completing the build."
    #Warning : Ninja doesn't return an error code on Linker error.
    #Store outputs in a file log

    #Only in powershell 7 (Gitlab 14+)
    # - cmake --build . --target sdk --config RelWithDebInfo --parallel $MAKEFILE_JOBS | Select-String -NotMatch -Raw -Pattern "inclusion du fichier"

    - cmake --build . --target sdk --config RelWithDebInfo --parallel $MAKEFILE_JOBS | find /V "inclusion du fichier" > ninja_buildlog.txt 2>&1


    # - cmake --build . --target sdk --config RelWithDebInfo --parallel $MAKEFILE_JOBS | find /V "inclusion du fichier" > ninja_buildlog.txt 2>&1
    #Print the file to get a feedback on CI
    - Get-Content ninja_buildlog.txt
    # - type ninja_buildlog.txt
    #GitlabCI stop at the first command that failed : Embedd commands in a script.
    #GitlabCI limitation : when having ': ', the whole line must be in ""
    - 'Write-Output "$isFound = (Select-String -Pattern `"build stopped: subcommand failed`" -SimpleMatch -Path -Quiet ninja_buildlog.txt)" > invertSearch.ps1'
    # - "Write-Output -NoEnumerate (Select-String -Pattern /C:\"build stopped: subcommand failed\" -SimpleMatch -Path ninja_buildlog.txt | Out-String) > invertSearch.ps1"
    # - "echo FINDSTR /C:\"build stopped: subcommand failed\" ninja_buildlog.txt > invertSearch.bat"
    # Inverse the status level of Select-String. It must be an error if the line has been found.
    #We do not use $LastExitCode because it only works for Win32 commands and not cmdlets
    # We do not use $? as it only gives the error code of the cmdlet (it shows if it succeeded, not if the pattern was found)
    - Write-Output -NoEnumerate "If (`$isFound -eq 0) {exit 1} else {exit 0}" >> invertSearch.ps1
    # - echo if ^%%ERRORLEVEL^%% EQU 0 (exit /b 1) else (exit /b 0) >> invertSearch.bat
    - Get-Content invertSearch.ps1
    - .\invertSearch.ps1
    - C:\PROGRA~1\Python37\Scripts\cl -s
################
  artifacts:
    paths:
      - build-desktop\linphone-sdk\*
    when: always
    expire_in: 1 week

.job-windows-vs2017-scheduled:
  extends: .job-windows-vs2017
  only:
    variables:
      - $NIGHTLY_MASTER
      - $NIGHTLY_RELEASE
      - $ENABLE_WINDOWS_TESTS
  before_script:
    #cache disabled on scheduled builds since we dot not need the fastest build
    - Set-Variable -Name "CLCACHE_DISABLE" -Value 1

######################################################
# JOBS
######################################################

job-windows-vs2017-ninja-win64:
  extends: .job-windows-vs2017-ninja
  variables:
    CMAKE_C_COMPILER : cl.exe
    CMAKE_CXX_COMPILER : cl.exe
    CMAKE_RC_COMPILER : rc.exe
    MINGW_TYPE: mingw64
    OUTPUT_ZIP_FOLDER: win64

job-windows-vs2017-ninja-win32:
  extends: .job-windows-vs2017-ninja
  # only:
  #   variables:
  #     - $ENABLE_WINDOWS_TESTS_WIN32_NINJA
  variables:
    CMAKE_C_COMPILER : cl.exe
    CMAKE_CXX_COMPILER : cl.exe
    CMAKE_RC_COMPILER : rc.exe

######################################################
# NIGHTLY
######################################################

##      ON SCHEDULE     ##
job-windows-vs2017-uwp-scheduled:
  extends: .job-windows-vs2017-scheduled
  only:
    variables:
      - $NIGHTLY_MASTER
      - $NIGHTLY_RELEASE
      - $DEPLOY_RUN_WINDOWS
      - $ENABLE_WINDOWS_UWP_TESTS
      - $ENABLE_WINDOWS_TESTS
  variables:
    CMAKE_C_COMPILER : cl.exe
    CMAKE_CXX_COMPILER : cl.exe
    CMAKE_RC_COMPILER : rc.exe
    LINPHONESDK_PLATFORM: UWP
    CMAKE_OPTIONS: -DENABLE_UNIT_TESTS=YES -DENABLE_LDAP=NO
    OUTPUT_ZIP_FOLDER: uwp
    MINGW_TYPE: mingw64
    CMAKE_GENERATOR: "Visual Studio 15 2017 Win64"

job-windows-vs2017-win32-scheduled:
  extends: .job-windows-vs2017-scheduled
  only:
    variables:
      - $NIGHTLY_MASTER
      - $NIGHTLY_RELEASE
      - $DEPLOY_RUN_WINDOWS
  variables:
    CMAKE_C_COMPILER : cl.exe
    CMAKE_CXX_COMPILER : cl.exe
    CMAKE_RC_COMPILER : rc.exe
    CMAKE_ARCHITECTURE : -A Win32
    CMAKE_OPTIONS: -DENABLE_UNIT_TESTS=YES -DENABLE_FFMPEG=YES -DENABLE_OPENH264=YES -DENABLE_NON_FREE_CODECS=YES -DENABLE_LDAP=NO
    OUTPUT_ZIP_FOLDER: win32

job-windows-vs2017-win32store-scheduled:
  extends: .job-windows-vs2017-scheduled
  only:
    variables:
      - $NIGHTLY_MASTER
      - $NIGHTLY_RELEASE
      - $DEPLOY_RUN_WINDOWS
  variables:
    CMAKE_C_COMPILER : cl.exe
    CMAKE_CXX_COMPILER : cl.exe
    CMAKE_RC_COMPILER : rc.exe
    CMAKE_OPTIONS: -DCMAKE_TOOLCHAIN_FILE=../cmake-builder/toolchains/toolchain-windows-store.cmake  -DENABLE_UNIT_TESTS=YES -DENABLE_FFMPEG=YES -DENABLE_OPENH264=YES -DENABLE_NON_FREE_CODECS=YES -DENABLE_LDAP=NO
    OUTPUT_ZIP_FOLDER: win32store

job-windows-vs2017-win32-novideo:
  extends: job-windows-vs2017-win32-scheduled
  only:
    variables:
      - $NIGHTLY_MASTER
      - $NIGHTLY_RELEASE
  variables:
    CMAKE_OPTIONS: -DENABLE_VIDEO=NO


#TODO : FACTORIZE TESTERS CODE

.test-linphone-windows:
  stage: test
  extends: .job-prepare
  tags: [ "windows" ]
  allow_failure: true
  variables:
    #no need to fetch repo, all the needed files are in input artifacts
    GIT_SUBMODULE_STRATEGY: none
    MINGW_TYPE: mingw32

  script:
    - set PATH_TEMP=%PATH:C:\MinGW\bin;=%
    - set PATH_TEMP=%PATH_TEMP:C:\Program Files\NASM=%
    - set PATH_TEMP=%PATH_TEMP:C:\Strawberry\c\bin;=%
    - set PATH=%PATH_TEMP%;C:\msys64;C:\msys64\usr\bin;C:\msys64\%MINGW_TYPE%\bin
    - IF "%MINGW_TYPE%"=="mingw64" (call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat") ELSE (call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\VsDevCmd.bat")
    - cd %CI_PROJECT_DIR%/build-desktop/linphone-sdk/desktop/

    #windows doesn't understand the meaning of the slash to launch an executable in basic command prompt
    - echo %CI_PROJECT_DIR%

    #When the dns host is set in command line, (--dns-hosts %CI_PROJECT_DIR%/linphone/tester/tester_hosts)
    #we have a weird bellesip error message
    #2019-04-30 11:28:17:372 belle-sip-error-hosts dns_hosts_loadfile(".../share/liblinphone_tester/C:/Users/Jenkins/linphone-sdk/linphone/tester/tester_hosts"): Unknown error

    #Procdumps generates a coredump if there is a crash
    # -ma : Write a dump file with all process memory. The default dump format only includes thread and handle information.

    # -e : Write a dump when the process encounters an unhandled exception. Include the 1 to create dump on first chance exceptions.
    # -x : Launch the specified image with optional arguments. If it is a Store Application or Package, ProcDump will start on the next activation (only).

    - procdump -ma -e -x . bin\liblinphone_tester.exe --parallel --verbose --show-account-manager-logs --log-file logLiblinphoneAllParThIpv6.txt --xml-file BCUnitAutomated-win

  after_script:
    - cd %CI_PROJECT_DIR%/build-desktop/linphone-sdk/desktop/bin
    - echo %CI_PROJECT_DIR%
    - mkdir "%CI_PROJECT_DIR%/results"
    - copy /B BCUnitAutomated* "%CI_PROJECT_DIR%/results"
    - copy /B logLiblinphoneAllParThIpv6* "%CI_PROJECT_DIR%/results"
    # Coredump management

    # The coredumps pattern is liblinphone_tester.exe_*, so we search
    # all coredumps matching it and we execute the cdb debugger on it.
    # -c : startup commands
    # .lines : explicitely tells cdb to load file lines infos for backtrace
    # !analyze -v : execute the debugger, prints the backtrace and some info('!' needs to be escaped with '^' since this script is considered as a batch file)
    # k : display backtrace with line numbers
    # q : quits
    # -ee c++ : use c++ expression syntax instead of MASM
    # -i [exe] : path to executable
    # -y symbols path
    # -z coredump location
    # -netsyms yes : searches for system symbols on the web if they are not found locally. Not doing this randomly prevents from loading our symbols
    - echo %cd%
    - dir
    - dir /b liblinphone_tester.exe_*
    - for /F %%v in ('dir /b liblinphone_tester.exe_*') do echo %%v
    - for /F %%v in ('dir /b liblinphone_tester.exe_*') do cdb -c ".lines; ^!analyze -v; k; q" -ee c++ -i liblinphone_tester.exe -y .;C:\WinSymbols -z %%v -netsyms yes

  artifacts:
    paths:
      - results/*
    when: always
    reports:
      junit:
        - results/BCUnitAutomated-win-Results.xml
    expire_in: 4 week

test-linphone-windows-win32-msbuild:
  extends: .test-linphone-windows
  only:
    variables:
      - $ENABLE_WINDOWS_TESTS
  needs:
    - job-windows-vs2017-win32-scheduled

test-linphone-windows-win32-ninja:
  extends: .test-linphone-windows
  only:
    variables:
      - $ENABLE_WINDOWS_TESTS_WIN32_NINJA
  needs:
    - job-windows-vs2017-ninja-win32

test-linphone-windows-win64-ninja:
  extends: .test-linphone-windows
  only:
    variables:
      - $ENABLE_WINDOWS_TESTS_WIN64_NINJA
      - $ENABLE_WINDOWS_TESTS
  needs:
    - job-windows-vs2017-ninja-win64

test-linphone-windows-uwp:
  stage: test
  extends: .job-prepare
  tags: [ "windows" ]
  allow_failure: true
  needs:
    - job-windows-vs2017-uwp-scheduled
  only:
    variables:
      - $ENABLE_WINDOWS_UWP_TESTS
      - $ENABLE_WINDOWS_TESTS
  variables:
    #no need to fetch repo, all the needed files are in input artifacts
    GIT_SUBMODULE_STRATEGY: none
    MINGW_TYPE: mingw64

  before_script:
    - powershell -command "taskkill /F /IM "LinphoneTester_uwp.exe" /T ; exit 0"
    - powershell -command "taskkill /F /IM "LinphoneTester_server.exe" /T ; exit 0"
    - powershell -command "Get-AppxPackage *LinphoneTester-uwp* | Remove-AppPackage"

  script:
  # Build VS project
  #Remove MinGW of MSYS from PATH and add MINGW_TYPE for MSYS2
    - set PATH_TEMP=%PATH:C:\MinGW\bin;=%
    - set PATH_TEMP=%PATH_TEMP:C:\Strawberry\c\bin;=%
    - set PATH_TEMP=%PATH_TEMP:C:\Program Files\NASM=%
    - set PATH=%PATH_TEMP%;C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\MSBuild\15.0\Bin;C:\Program Files (x86)\Windows Kits\10\bin\10.0.17763.0\x86;C:\msys64;C:\msys64\usr\bin;C:\msys64\%MINGW_TYPE%\bin
    - cd %CI_PROJECT_DIR%\build-desktop\linphone-sdk\uwp-x64
    - set LINPHONE_PATH=%cd%
    - cd %CI_PROJECT_DIR%\tester\Windows\LinphoneTester_uwp
    - powershell -command "Get-AppxPackage *LinphoneTester-uwp* | Remove-AppPackage"
    - powershell -command "Remove-Item x64 -Recurse -Force ; exit 0"
    - powershell -command "Remove-Item AppPackages -Recurse -Force ; exit 0"
    - ..\..\..\cmake\Windows\nuget\nuget.exe Restore
    - msbuild /t:restore
    - msbuild /p:AppxBundle=Always /p:AppxBundlePlatforms="x64" LinphoneTester_uwp.sln /p:Configuration=Release /p:Platform=x64 /Verbosity:minimal /p:LinphoneSDK-Path=%LINPHONE_PATH%
    - powershell -command "Remove-Item AppPackages -Recurse -Force ; exit 0"
    - makeappx unpack /p x64\Release\LinphoneTester_uwp\LinphoneTester_uwp_1.0.0.0_x64.appx /d x64\Release\LinphoneTester_uwp\ /o
    - powershell -command "Add-AppxPackage -Register .\x64\Release\LinphoneTester_uwp\AppxManifest.xml"
    - call UpdatePermissions.bat
    - echo %USERDOMAIN%\%USERNAME%
    - start "Tester Server" ..\LinphoneTester_server\bin\Release\LinphoneTester_server.exe
    - start /wait LinphoneTester_uwp.exe --parallel --parallel-max 10
    - powershell -command "taskkill /F /IM "LinphoneTester_uwp.exe" /T ; exit 0"
    - powershell -command "taskkill /F /IM "LinphoneTester_server.exe" /T ; exit 0"
    #- procdump -ma -e -x . LinphoneTester_uwp.exe --parallel --silent

  after_script:
    - powershell -command "taskkill /F /IM "LinphoneTester_uwp.exe" /T ; exit 0"
    - powershell -command "taskkill /F /IM "LinphoneTester_server.exe" /T ; exit 0"
    - powershell -command "(Get-AppxPackage *LinphoneTester-uwp*).PackageFamilyName" > packageFolder.txt
    - set /p PACKAGE_FOLDER=<packageFolder.txt
    - del packageFolder.txt
    - mkdir "%CI_PROJECT_DIR%/results"
    - copy /B %LOCALAPPDATA%\Packages\%PACKAGE_FOLDER%\LocalState\LibLinphoneWindows10* "%CI_PROJECT_DIR%/results"
    - powershell -command "Get-AppxPackage *LinphoneTester-uwp* | Remove-AppPackage"

    #- cd %CI_PROJECT_DIR%/build-desktop/linphone-sdk/uwp-x64/bin
    #- echo %cd%
    #- dir
    #- dir /b liblinphone_tester.exe_*
    #- for /F %%v in ('dir /b liblinphone_tester.exe_*') do echo %%v
    #- for /F %%v in ('dir /b liblinphone_tester.exe_*') do cdb -c ".lines; ^!analyze -v; k; q" -ee c++ -i liblinphone_tester.exe -y .;C:\WinSymbols -z %%v -netsyms yes

    #- echo %CI_PROJECT_DIR%
    #- mkdir "%CI_PROJECT_DIR%/results"
    #- dir
    #- copy /B BCUnitAutomated* "%CI_PROJECT_DIR%/results"
    #- copy /B logLiblinphoneAllParThIpv6* "%CI_PROJECT_DIR%/results"

  artifacts:
    paths:
      - results/*
    when: always
    reports:
      junit:
        - results/LibLinphoneWindows10-Results.xml
    expire_in: 4 week
