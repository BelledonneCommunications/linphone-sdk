.job-windows:

  extends: .job-prepare
  stage: build
  tags: [ "windows" ]

  except:
    variables:
      - $DEPLOY_RUN_ANDROID
      - $DEPLOY_RUN_IOS

  script:
    - mkdir build-desktop
    - cd build-desktop
    - cmake .. -G "%VISUAL_STUDIO_VERSION%" -DLINPHONESDK_PLATFORM=Desktop  -DENABLE_CSHARP_WRAPPER=%CSHARP_WRAPPER% -DCMAKE_BUILD_TYPE=Release %DEFAULT_CMAKE_OPTIONS% %CMAKE_OPTIONS%
    - cmake --build . --target sdk --config Release -- /m /nodeReuse:true /p:TrackFileAccess=false /p:BuildInParallel=true /p:CreateHardLinksForCopyLocalIfPossible=true /p:CreateHardLinksForCopyFilesToOutputDirectoryIfPossible=true /p:CreateHardLinksForCopyAdditionalFilesIfPossible=true /p:CreateHardLinksForPublishFilesIfPossible=true

#################################################
# VS2015
#################################################

job-windows-vs2015:
  extends: .job-windows
  only:
    - schedules
  variables:
    CSHARP_WRAPPER: "NO"
    VISUAL_STUDIO_VERSION: Visual Studio 14 2015

job-windows-vs2015-novideo:
  variables:
    CMAKE_OPTIONS: -DENABLE_VIDEO=NO
  extends: job-windows-vs2015

#################################################
# VS2017
#################################################

job-windows-vs2017:
  extends: .job-windows
  variables:
    CSHARP_WRAPPER: "YES"
    VISUAL_STUDIO_VERSION: Visual Studio 15 2017
  artifacts:
    paths:
      - build-desktop/linphone-sdk/desktop/
    when: always
    expire_in: 1 day

job-windows-vs2017-novideo:
  only:
    - schedules
  variables:
    CMAKE_OPTIONS: -DENABLE_VIDEO=NO
  extends: job-windows-vs2017

job-windows-vs2017-package:
  stage: package
  tags: [ "windows" ]
  dependencies:
    - job-windows-vs2017
  script:
    - call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\VsDevCmd.bat"
    - cd build-desktop
    - chdir > chdir_sdk.temp
    - set /p OUTPUT_SDK_BUILD=<chdir_sdk.temp
    - cd ..\cmake\Windows\wrapper\
    - chdir > chdir_wrapper.temp
    - set /p OUTPUT_WRAPPER_BUILD=<chdir_wrapper.temp
    - msbuild -t:restore CsWrapper.csproj
    - msbuild CsWrapper.csproj /p:MDILCompile=true /p:Platform="x86" /t:build /p:Configuration=Release /p:OutputSdkBuild=%OUTPUT_SDK_BUILD%
    - cd ..\nuget
    - git describe > describe.temp
    - set /p DESCRIBE=<describe.temp
    - msbuild NuGetLinphoneSDK.vcxproj /p:VersionNumber=%DESCRIBE% /p:OutputSdkBuild=%OUTPUT_SDK_BUILD% /p:OutputWrapperBuild=%OUTPUT_WRAPPER_BUILD%
  artifacts:
    paths:
      - cmake\Windows\nuget\*.nupkg
    when: always
    expire_in: 1 week
 