#################################################
# VS2015
#################################################
#Wedo not need vs2015 anymore

#job-windows-vs2015:
#
#  extends: .job-prepare
#  stage: build
#  tags: [ "windows" ]
#  except:
#    refs:
#      - feature/peioMergeCi
#
#  except:
#    variables:
#      - $DEPLOY_RUN_ANDROID
#      - $DEPLOY_RUN_IOS
#  variables:
#    CMAKE_OPTIONS: -DENABLE_LIME_X3DH=NO
#
#  script:
#    - mkdir build-desktop
#    - cd build-desktop
#    - cmake .. -G "Visual Studio 14 2015" -DLINPHONESDK_PLATFORM=Desktop -DCMAKE_BUILD_TYPE=Release %DEFAULT_CMAKE_OPTIONS% %CMAKE_OPTIONS%
#   - cmake --build . --target sdk --config Release -- /maxcpucount

#job-windows-vs2015-novideo:
#
#  only:
#    - schedules
#  except:
#    variables:
#      - $DEPLOY_RUN_ANDROID
#      - $FAST_LINUX_TESTS
#  variables:
#    CMAKE_OPTIONS: -DENABLE_VIDEO=NO
#  extends: job-windows-vs2015

.job-windows-vs2017:
  extends: .job-prepare
  stage: build
  tags: [ "windows" ]
  
  variables:
    CMAKE_OPTIONS: -DENABLE_LIME_X3DH=NO -DENABLE_UNIT_TESTS=ON

  script:
    #handling the case of previous job cancellation
    - IF EXIST build-desktop RMDIR /S /Q build-desktop
    - mkdir build-desktop
    - cd build-desktop
    
    #we launch the msvc-cl wrapper located in python scripts folder
    #this wrapper relays only needed calls to the real compiler
    
    #cache stats display
    - C:\PROGRA~1\Python37\Scripts\cl -s
    
    - cmake .. -G "Visual Studio 15 2017" -DLINPHONESDK_PLATFORM=Desktop -DENABLE_CSHARP_WRAPPER=YES -DCMAKE_BUILD_TYPE=Release %DEFAULT_CMAKE_OPTIONS% %CMAKE_OPTIONS%
    - cmake --build . --target sdk --config Release -- /maxcpucount /nodeReuse:true /p:TrackFileAccess=false
    - C:\PROGRA~1\Python37\Scripts\cl -s
  artifacts:
    paths:
      - build-desktop\linphone-sdk\desktop
    when: always
    expire_in: 1 week
            
.job-windows-vs2017-scheduled:
  extends: .job-windows-vs2017

  only:
    variables:
      - $NIGHTLY_MASTER
      - $PACKAGE_RUN_WINDOWS
  before_script: 
    #cache disabled on scheduled builds since we dot not need the fastest build
    - set "CLCACHE_DISABLE=1"
    
    
job-windows-vs2017:
  extends: .job-windows-vs2017
  except:
    refs:
      - schedules
      
job-windows-vs2017-scheduled:
  extends: .job-windows-vs2017-scheduled
    
job-windows-vs2017-novideo:
  extends: .job-windows-vs2017-scheduled
  variables:
    CMAKE_OPTIONS: -DENABLE_LIME_X3DH=NO -DENABLE_VIDEO=NO

test-linphone-windows:
  stage: test
  extends: .job-prepare
  tags: [ "windows" ]
  allow_failure: true
  dependencies:
    - job-windows-vs2017
  only:
    refs:
      - feature/tests_ci_windows
  variables:
    GIT_SUBMODULE_STRATEGY: none

  script:
    - cd %CI_PROJECT_DIR%/build-desktop/linphone-sdk/desktop/bin
    
    #windows doesn't understand the meaning of the slash to launch an executable in basic command prompt
    - echo %CI_PROJECT_DIR%
    - .\liblinphone_tester --verbose --dns-hosts ../../../../../linphone/tester/tester_hosts --show-account-manager-logs --log-file logLiblinphoneAllParThIpv6.txt --xml-file BCUnitAutomated-Results.xml
  
  after_script:
    - cd %CI_PROJECT_DIR%/build-desktop/linphone-sdk/desktop/bin
    # searching for core files and if there are some, launch gdb on all of it
    # "true ||" is used here to continue the script even if the find fails
    #- if [[ -n $(find . -type f -name "core*") ]]; then find . -type f -name "core*" | xargs -L1 lldb --batch -o 'thread backtrace all' -o 'quit' -c ; fi || true
    - echo %CI_PROJECT_DIR%
    - cd %CI_PROJECT_DIR%
    - mkdir %CI_PROJECT_DIR%/results
    - cp -r BCUnitAutomated* %CI_PROJECT_DIR%/results
    - cp -r $LOG_PATTERN* %CI_PROJECT_DIR%/results
    
  artifacts:
    paths:
      - results/*
    when: always
    expire_in: 4 week
