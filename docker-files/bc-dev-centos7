FROM centos:7

MAINTAINER Ghislain MARY <ghislain.mary@belledonne-communications.com>

#ENV RPM_BUILD_NCPUS=5
ENV SHELL=/bin/bash

# Configure additional repositories and install common general tools
RUN yum install -y epel-release && \
    rpm --import http://li.nux.ro/download/nux/RPM-GPG-KEY-nux.ro && rpm -Uvh http://li.nux.ro/download/nux/dextop/el7/x86_64/nux-dextop-release-0-1.el7.nux.noarch.rpm && \
    yum install -y nano sudo which && \
    yum clean all

# Install development tools
RUN yum install -y ccache clang cmake doxygen gcc-c++ gdb gettext-devel git graphviz libtool make nasm patch pystache python-six python2-pip rpm-build yasm && \
    curl -o cmake.tar.gz https://cmake.org/files/v3.2/cmake-3.2.3.tar.gz && \
    tar xvzf cmake.tar.gz && rm cmake.tar.gz && cd cmake-3.2.3 && cmake . && make -j5 install && cd .. && rm -rf cmake-3.2.3 && \
    yum erase -y cmake && \
    yum clean all && \
    pip install sphinx javasphinx sphinx_csharp

# Install jenkins dependencies
#RUN yum install -y java-1.8.0-openjdk openssh-server && \
#    yum clean all && \
#    mkdir -p /var/run/sshd

# Install linphone dependencies development packages
RUN yum install -y alsa-lib-devel ffmpeg-devel glew-devel gsm-devel libbsd-devel libsrtp-devel libv4l-devel libvpx-devel libXv-devel libxml2-devel mbedtls-devel mesa-libEGL-devel openssl-devel opus-devel pulseaudio-libs-devel speex-devel sqlite-devel xerces-c-devel && \
    yum clean all

# Install linphone runtime dependencies
RUN yum install -y mesa-dri-drivers && \
    yum clean all && \
    dbus-uuidgen > /var/lib/dbus/machine-id

# Build qt5.10.1
#RUN git clone git://git.linphone.org/linphone-desktop.git && ./linphone-desktop/tools/build_qt_rpm && rpm -i ./linphone-desktop/rpm-linphone-qt-5.10.1/rpmbuild/RPMS/x86_64/*.rpm && mv ./linphone-desktop/rpm-linphone-qt-5.10.1/rpmbuild/RPMS/x86_64/*.rpm / && rm -rf ./linphone-desktop

# Configure user bc
RUN useradd -ms /bin/bash bc && \
    echo 'bc:cotcot' | chpasswd && \
    echo 'bc ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

#EXPOSE 22
EXPOSE 5060/udp
EXPOSE 5060/tcp
EXPOSE 5061

#CMD ["/usr/sbin/sshd", "-D"]

USER bc
WORKDIR /home/bc
ENV PS1='\[\e[34m\]\u@bc-dev-centos7>\[\e[0m\] '
#ENV Qt5_DIR='/opt/com.belledonne-communications/linphone/lib/cmake'
CMD bash

